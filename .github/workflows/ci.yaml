name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# 同時実行を直列化（同一ブランチでの重複実行をキャンセル）
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  FRONTEND_DIR: frontend
  BACKEND_DIR: backend

# NOTE:
# - This workflow runs independent frontend (Next.js) and backend (Go) quality gates.
# - Backend go.mod declares go 1.23/toolchain; we configure setup-go to read directly from go.mod
#   so versions do not drift (previously hard-coded 1.22 causing mismatch).
# - A Docker image for the backend is built only after backend job succeeds.
# - Future enhancement (integration tests needing PostgreSQL): add a Postgres service block (see commented snippet below).
#
# Example service snippet (uncomment when integration tests are added):
# services:
#   postgres:
#     image: postgres:16-alpine
#     env:
#       POSTGRES_USER: test
#       POSTGRES_PASSWORD: test
#       POSTGRES_DB: cot_game
#     ports: ["5432:5432"]
#     options: >-
#       --health-cmd="pg_isready -U test" --health-interval=10s --health-timeout=5s --health-retries=5

jobs:
  # ===================== Frontend (Next.js) =====================
  frontend:
    name: Frontend (Next.js)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.FRONTEND_DIR }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ${{ env.FRONTEND_DIR }}/package-lock.json

      - name: Install deps
        run: npm ci

      - name: Prepare env (from .env.example if present)
        run: |
          if [ -f .env.example ] && [ ! -f .env ]; then
            cp .env.example .env
          fi

      - name: Lint
        run: |
          if npm run | grep -q "eslint"; then
            npm run eslint || npm run lint || true
          elif npm run | grep -q "lint"; then
            npm run lint
          else
            echo "No lint script. Skipping."
          fi

      - name: Test
        run: |
          if npm run | grep -q "test"; then
            npm test -- --ci --watchAll=false
          else
            echo "No test script. Skipping."
          fi

      - name: Build
        run: |
          if npm run | grep -q "build"; then
            npm run build
          else
            echo "No build script. Skipping."
          fi

      - name: Upload frontend artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: next-build
          path: |
            ${{ env.FRONTEND_DIR }}/.next
            ${{ env.FRONTEND_DIR }}/next.config.* 
            ${{ env.FRONTEND_DIR }}/public
          if-no-files-found: warn

  # ===================== Backend (Go) =====================
  backend:
    name: Backend (Go)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.BACKEND_DIR }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go (use version from go.mod)
        uses: actions/setup-go@v5
        with:
          go-version-file: ${{ env.BACKEND_DIR }}/go.mod
          cache: true

      - name: Show Go env
        run: |
          go version
          go env | grep -E 'GOVERSION|GOMOD|GOMODCACHE'

      - name: Module tidy (ensure clean)
        run: go mod tidy

      - name: Verify no diff after tidy
        run: |
          if ! git diff --quiet --exit-code; then
            echo "go mod tidy produced changes (consider committing)." >&2
            git --no-pager diff
          fi

      - name: Build (all packages)
        run: go build ./...

      - name: Build distributable binary
        run: |
          mkdir -p dist
          go build -o dist/backend ./

      - name: Test
        run: go test ./... -v

      - name: GolangCI-Lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: v1.60
          working-directory: ${{ env.BACKEND_DIR }}
          args: --timeout=5m

      - name: Upload backend binary artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: backend-bin
          path: ${{ env.BACKEND_DIR }}/dist/backend
          if-no-files-found: error

  # ===================== Docker (Backend Image) =====================
  docker:
    name: Docker Build (Backend)
    runs-on: ubuntu-latest
    needs: [backend] # Goのビルド/テストが通ったら
    permissions:
      contents: read
      packages: write # GHCR に push する場合
    defaults:
      run:
        working-directory: ${{ env.BACKEND_DIR }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # --- GHCR/Docker Hub に push したい場合はログインを有効化 ---
      # リポジトリの Settings > Secrets and variables > Actions に以下を設定
      #   GHCR_USERNAME = github.actor（推奨）
      #   GHCR_TOKEN    = GitHub Personal Access Token (write:packages)
      # Login step (commented out by default). Uncomment and set repository secrets GHCR_USERNAME / GHCR_TOKEN.
      # - name: Login to GHCR
      #   uses: docker/login-action@v3
      #   with:
      #     registry: ghcr.io
      #     username: ${{ github.actor }} # or secrets.GHCR_USERNAME
      #     password: ${{ secrets.GHCR_TOKEN }}

      - name: Docker meta (tags/labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/${{ github.repository }}/backend
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build (no push by default)
        uses: docker/build-push-action@v6
        with:
          context: ${{ env.BACKEND_DIR }}
          file: ${{ env.BACKEND_DIR }}/Dockerfile
          push: false # set to true only when login enabled
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
