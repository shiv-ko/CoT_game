# 📅 開発プラン（2025-09-07）

本ドキュメントは、プロンプトバトルWebアプリの次フェーズ開発計画です。既存の仕様（docs/app.md）と進捗（docs/progresses/progress_0810.md）を前提とし、短期スプリントで機能を完成させます。

---

## 0. 現状と前提
- 実装済み: 「問題バンクAPI」(`/api/v1/questions`)。Docker で起動・疎通確認済み。
- DB: `users`, `questions`, `scores` が既存（`scores`に実行ログ/スコアを保存可能）。
- 目標: AI連携→入力UI→評価保存→ランキング の順で MVP 完了。
- 非スコープ（本計画内では扱わない）: 本格的な認証・課金、運用監視高度化、A/Bテスト。

---

## 1. マイルストーン（3スプリント）

### Sprint 1（〜2025-09-14）AI連携API + 評価ロジック
- バックエンド: Gemini 連携クライアント層の実装（環境変数 `GEMINI_API_KEY`）。
- エンドポイント: `POST /api/v1/solve`（入力: `question_id`, `prompt`, `model`）。
- 評価: 数値抽出 + 許容誤差評価（完全一致/小誤差/失敗）。
- DB: `scores` テーブルへ保存。必要なら以下を追加（マイグレーション）：
  - `model_vendor TEXT`（例: `gemini`）
  - `model_name TEXT`（例: `gemini-1.5-pro`）
  - `answer_number NUMERIC NULL`（抽出した数値）
  - `latency_ms INT`，`evaluation_detail JSONB`
- テスト: 評価ユニットテスト、ハンドラ結合テスト。
- DoD:
  - `POST /api/v1/solve` が 200 を返し、`{question_id,prompt,ai_output,answer_number,score,elapsed_ms}` を返却。
  - `scores` に結果が1行保存される（`user_id` はゲスト可）。

### Sprint 2（〜2025-09-21）フロントUI（送信/結果表示）+ ルール整備
- ページ: 問題一覧 → 問題詳細/送信フォーム（Next.js）。
- 機能: プロンプト送信、ローディング・エラー表示、結果（AI出力/スコア）表示。
- クライアント: API クライアント util、環境変数で API Base URL 切替。
- コスト対策: 簡易レートリミット（IP 単位 / 分）。
- テスト: コンポーネント/軽いE2E（Happy path）。
- DoD:
  - UI から実際に解答→評価→保存が一連で動作。
  - 想定外入力時もユーザー向けメッセージで復帰可能。

### Sprint 3（〜2025-09-28）ランキング/履歴 + 品質/運用
- API: `GET /api/v1/leaderboard`，`GET /api/v1/scores`（ユーザー/期間でフィルタ）。
- UI: ランキング、自己履歴（簡易）。
- 品質: ログ整備、エラーフォーマット統一、CI（lint/test/build）追加。
- セキュリティ: レートリミット強化、入力バリデーション、APIキー管理見直し。
- DoD:
  - ランキング/履歴が表示でき、最低限の運用観点（ログ/CI）が整備。

---

## 2. 詳細タスク

### 2.1 バックエンド（Go）
- `internal/ai/gemini_client.go`: リクエスト/レスポンス型、タイムアウト、リトライ。
- `internal/eval/evaluator.go`: 数値抽出（正規表現）、誤差判定（絶対/相対）。
- `handlers/solve_handler.go`: 入力バリデーション、Gemini呼出、評価、DB保存、応答生成。
- `routes/solve_routes.go`: `POST /api/v1/solve` ルーティング。
- `storage/scores_repo.go`: `scores` 永続化、検索（ランキング/履歴）。
- 追加マイグレーション（必要時）: `db/migrations/20250907_add_scores_columns.sql`。

### 2.2 フロントエンド（Next.js）
- 画面: `QuestionsList` / `QuestionDetail`（送信フォーム）/ `Leaderboard` / `MyHistory`。
- 状態: フェッチ状態（loading/error/success）、再試行、入力バリデーション。
- APIクライアント: `src/lib/api.ts`（`fetch` ラッパ、ベースURL/タイムアウト）。
- UI/UX: 送信後の結果モジュール（AI出力・抽出値・スコア・所要時間）。

### 2.3 共通/運用
- レートリミット: ミドルウェア（IPごとN req/min）。
- ログ: 構造化ログ（request_id, latency, score など）。
- CI: GitHub Actions（lint, test, docker build）。
- ドキュメント: `docs/app.md` 追記、プログレスログの運用（毎日）。

---

## 3. API 仕様（ドラフト）

### POST /api/v1/solve
- Body: `{ "question_id": number, "prompt": string, "model": "gemini-1.5-pro" }`
- 200 OK: `{
  "question_id": number,
  "prompt": string,
  "model_vendor": "gemini",
  "model_name": "gemini-1.5-pro",
  "ai_output": string,
  "answer_number": number | null,
  "score": number,
  "evaluation": { "mode": "exact|tolerance|fail", "tolerance": 0.01 },
  "elapsed_ms": number,
  "saved": true
}`
- 4xx/5xx: エラーフォーマット統一 `{ code, message, detail? }`

### GET /api/v1/leaderboard
- Query: `period=day|week|all`, `limit=50`
- 200 OK: `[{ user_id, username, best_score, attempts, last_at }]`

### GET /api/v1/scores
- Query: `user_id?`, `from?`, `to?`, `limit?`
- 200 OK: `[{ id, question_id, score, prompt_len, created_at }]`

---

## 4. DB 変更（必要時）
- 既存 `scores` 拡張案:
  - `model_vendor TEXT DEFAULT 'gemini' NOT NULL`
  - `model_name TEXT`
  - `answer_number NUMERIC NULL`
  - `latency_ms INT DEFAULT 0 NOT NULL`
  - `evaluation_detail JSONB NULL`
- インデックス: `scores (question_id)`, `scores (user_id, submitted_at DESC)`

---

## 5. テスト戦略
- 単体: evaluator（境界値、小数誤差、非数値）/ パーサ。
- 結合: solve ハンドラ（モックAI）, scores リポジトリ。
- E2E（限定）: 問題選択→送信→結果表示のハッピーパス。

---

## 6. リスクと対策
- 数値抽出失敗: パターン拡張/フォールバック（複数候補のうち最頻/最後を採用）。
- レイテンシ/コスト: レート制限、タイムアウト、失敗時リトライ回数上限。
- スキーマ変更: マイグレーションにロールバック手順を用意。

---

## 7. 作業順チェックリスト（抜粋）
- [ ] `POST /api/v1/solve` 実装・テスト
- [ ] evaluator ユニットテスト 10+ ケース
- [ ] `scores` 保存/取得リポジトリ
- [ ] フロント送信フォーム + 結果表示
- [ ] ランキングAPI + UI
- [ ] レートリミット/ログ/CI

---

## 8. アサイン/工数（目安）
- BE: 3〜4日（API, 評価, 追加カラム, テスト）
- FE: 3日（一覧/詳細/送信/UI/軽E2E）
- 運用: 1〜2日（CI, レート制限, ログ）

以上。

