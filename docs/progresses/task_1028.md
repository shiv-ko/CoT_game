# 2025年10月28日 タスク

### 完了条件

- [x] 問題一覧テーブルで `problem_statement` カラムを削除
- [x] 問題詳細ページから問題文表示セクションを削除
- [x] ページタイトルを「問題 #{id}」のままにするか、「問題に挑戦」などに変更
- [x] バックエンドで問題文を取得
- [x] システムプロンプト(問題文を含む指示)を構築
- [x] ユーザープロンプトと結合してAIに送信するロジックをテスト可能な関数として実装
- [x] 問題一覧ページ用のCSSモジュールを作成(`QuestionsTable.module.css`)
- [x] 問題詳細ページ用のCSSモジュールを作成(`QuestionDetail.module.css`)
- [x] Questions API のレスポンスから `problem_statement` と `correct_answer` を除外
- [x] フロントエンドで必要な情報のみを取得(id, level, created_at)
- [x] 型定義を更新
- [x] 既存のコンポーネントが正常に動作することを確認
- [x] 答え合わせの際も、問題文や正解はクライアント側に送信せずに、サーバー側で答え合わせをする
- [x] 結果表示コンポーネント用のCSSモジュールを作成(`SolveResult.module.css`)
- [x] インラインスタイルをCSSクラスに置き換え
- [x] レスポンシブデザイン対応(モバイル、タブレット、デスクトップ)
- [x] 統一されたカラーパレットとタイポグラフィを適用
- [x] ユーザーには「難易度」のみを伝える
- [x] プロンプト入力エリアに説明文を追加(例: "この問題を解くためのプロンプトを入力してください")
- [x] 代わりに「問題ID」「難易度」「操作」のみを表示
- [x] または、問題の概要(例: "数学問題", "論理パズル"など)を表示する簡易的な説明を追加

## 実施日
      2025年10月28日

## 対応ブランチ

`feat/10-11-solve-ui`

---

## タスク1: 問題一覧画面の問題文非表示対応

### 背景

- 現在、問題一覧ページ (`/questions/page.tsx`) の `QuestionsTable` コンポーネントで、`problem_statement` 全文を表示している
- ユーザーが問題を見てしまうと、自分で答えを考えてしまうため、プロンプト作成の本来の目的から外れる
- ゲームの趣旨として、ユーザーは問題文を見ずにプロンプトを工夫してAIに正解を導き出させるべき

### 完了条件

- [ ] 問題一覧テーブルで `problem_statement` カラムを削除
- [ ] 代わりに「問題ID」「難易度」「操作」のみを表示
- [ ] または、問題の概要（例: "数学問題", "論理パズル"など）を表示する簡易的な説明を追加

### 実装詳細

**ファイル**: `/Users/shiv/P/CoT_game/frontend/src/app/questions/components/QuestionsTable.tsx`

**変更内容**:

1. テーブルヘッダーから「問題文」カラムを削除
2. テーブルボディから `{question.problem_statement}` の表示を削除
3. 必要に応じて「説明」カラムを追加（例: "レベル{level}の問題"）

**影響範囲**:

- フロントエンドUIのみ（API変更なし）

---

## タスク2: 問題詳細画面の問題文非表示対応

### 背景

- 現在、問題詳細ページ (`/questions/[id]/page.tsx`) で問題文を表示している
- タスク1と同じ理由で、ユーザーに問題文を見せるべきではない
- プロンプト入力フォームのみを表示し、ユーザーは「この問題を解くための最適なプロンプト」を考える

### 完了条件

- [ ] 問題詳細ページから問題文表示セクションを削除
- [ ] ページタイトルを「問題 #{id}」のままにするか、「問題に挑戦」などに変更
- [ ] ユーザーには「難易度」のみを伝える
- [ ] プロンプト入力エリアに説明文を追加（例: "この問題を解くためのプロンプトを入力してください"）

### 実装詳細

**ファイル**: `/Users/shiv/P/CoT_game/frontend/src/app/questions/[id]/page.tsx`

**変更内容**:

1. 問題の説明セクション（`backgroundColor: '#f9fafb'` のdiv）を削除
2. ヘッダー部分は残す（難易度情報は表示）
3. プロンプト入力フォームの説明を充実させる

**影響範囲**:

- フロントエンドUIのみ（API変更なし）

---

## タスク3: AIモデル選択UIの変更

### 背景

- 現在、モデル選択で「Gemini 1.5 Flash」と「Gemini 1.5 Pro」の2つを選択可能にしている
- 実際には、モデルを変更する機能は現時点では不要
- デフォルトモデルを最新の「Gemini 2.0 Flash Lite」に統一したい

### 完了条件

- [x] フロントエンド: モデル選択セレクトボックスを削除
- [x] フロントエンド: デフォルトモデルを `gemini-2.0-flash-lite` に固定
- [x] バックエンド: デフォルトモデルを `gemini-2.0-flash-lite` に変更
- [x] UI上はモデル選択を表示せず、内部的に固定値を使用

### 実装詳細

#### フロントエンド

**ファイル**: `/Users/shiv/P/CoT_game/frontend/src/app/questions/[id]/page.tsx`

**変更内容**:

1. `modelName` の初期値を `'gemini-2.0-flash-exp'` に変更
2. モデル選択セレクトボックスのセクション全体を削除
3. state は残すが、UI上は表示しない（将来の拡張性のため）

#### バックエンド

**ファイル1**: `/Users/shiv/P/CoT_game/backend/handlers/solve_handler.go`

- デフォルトモデルを `"gemini-2.0-flash-lite"` に変更

**ファイル2**: `/Users/shiv/P/CoT_game/backend/internal/ai/gemini_client.go`

- `defaultModel` 定数を `"gemini-2.0-flash-lite"` に変更

**ファイル3**: `/Users/shiv/P/CoT_game/backend/.env`

- `AI_MODEL_NAME=gemini-2.0-flash-lite` に変更

**影響範囲**:

- フロントエンド: UI変更
- バックエンド: デフォルト値変更のみ（API互換性は維持）

---

## タスク4: システムプロンプトの追加（プロンプト結合機能）

### 背景

- 現在、ユーザーが入力したプロンプトをそのままAIに送信している
- ユーザーのプロンプトだけでは、AIが問題文を知らないため正解を導けない
- システム側で問題文をプロンプトに埋め込み、「指示 + 問題文 + ユーザープロンプト」の形でAIに送信する必要がある

### 完了条件

- [ ] バックエンドで問題文を取得
- [ ] システムプロンプト（問題文を含む指示）を構築
- [ ] ユーザープロンプトと結合してAIに送信
- [ ] 結合ロジックをテスト可能な関数として実装

### 実装詳細

#### バックエンド

**ファイル**: `/Users/shiv/P/CoT_game/backend/handlers/solve_handler.go`

**変更内容**:

1. `PostSolve` ハンドラ内で、`getCorrectAnswer` と同様に `getProblemStatement` 関数を追加
2. システムプロンプトを構築する関数 `buildSystemPrompt` を実装

**システムプロンプトの構造例**:

```
以下の問題を解いてください。

【問題】
{problem_statement}

【指示】
{user_prompt}

必ず最終的な答えだけを出力してください。
```

**実装例**:

```go
// getProblemStatement は question_id から問題文を取得します。
func (h *SolveHandler) getProblemStatement(ctx context.Context, questionID int) (string, error) {
	query := "SELECT problem_statement FROM questions WHERE id = $1"
	var problemStatement string
	err := h.DB.QueryRowContext(ctx, query, questionID).Scan(&problemStatement)
	return problemStatement, err
}

// buildCombinedPrompt はシステムプロンプトとユーザープロンプトを結合します。
func buildCombinedPrompt(problemStatement, userPrompt string) string {
	return fmt.Sprintf(`以下の問題を解いてください。

【問題】
%s

【指示】
%s

必ず最終的な答えだけを出力してください。`, problemStatement, userPrompt)
}
```

**変更箇所**:

1. `PostSolve` 内で `getProblemStatement` を呼び出し
2. `buildCombinedPrompt` で問題文とユーザープロンプトを結合
3. 結合後のプロンプトを `h.AIClient.Generate(ctx, combinedPrompt)` に渡す
4. **重要**: レスポンスの `Prompt` フィールドには、ユーザープロンプト（元のまま）を返す（セキュリティ上、問題文は返さない）

**影響範囲**:

- バックエンド: solve_handler.go のみ
- API仕様: 変更なし（内部処理のみ）
- フロントエンド: 影響なし

**注意事項**:

- 問題文が存在しない場合のエラーハンドリングを追加
- システムプロンプトのフォーマットは将来的に設定ファイル化する可能性あり

---

## タスク5: CSSモジュールの導入とデザイン改善

### 背景

- 現在、すべてのスタイルをインラインスタイル（`style={{ ... }}`）で記述している
- コードの可読性が低く、メンテナンスが困難
- Next.jsのCSS Modulesを活用して、スタイルを分離し、保守性を向上させたい
- スマートで統一感のあるデザインを適用したい

### 完了条件

- [ ] 問題一覧ページ用のCSSモジュールを作成（`QuestionsTable.module.css`）
- [ ] 問題詳細ページ用のCSSモジュールを作成（`QuestionDetail.module.css`）
- [ ] 結果表示コンポーネント用のCSSモジュールを作成（`SolveResult.module.css`）
- [ ] インラインスタイルをCSSクラスに置き換え
- [ ] レスポンシブデザイン対応（モバイル、タブレット、デスクトップ）
- [ ] 統一されたカラーパレットとタイポグラフィを適用

### 実装詳細

#### デザインシステムの定義

**カラーパレット**:

```css
--primary-color: #3b82f6; /* メインカラー（青） */
--primary-hover: #2563eb; /* ホバー時 */
--secondary-color: #6b7280; /* セカンダリ（グレー） */
--success-color: #22c55e; /* 成功（緑） */
--warning-color: #f59e0b; /* 警告（オレンジ） */
--danger-color: #ef4444; /* エラー（赤） */
--info-color: #3b82f6; /* 情報（青） */
--bg-primary: #ffffff; /* 背景（白） */
--bg-secondary: #f9fafb; /* セカンダリ背景 */
--border-color: #e5e7eb; /* ボーダー */
--text-primary: #111827; /* メインテキスト */
--text-secondary: #6b7280; /* サブテキスト */
```

#### ファイル1: QuestionsTable.module.css

**パス**: `/Users/shiv/P/CoT_game/frontend/src/app/questions/components/QuestionsTable.module.css`

**内容**:

- テーブルレイアウト
- ヘッダースタイル
- 行のホバーエフェクト
- 「解く」ボタンのスタイル
- レスポンシブ対応（スマホでは横スクロール可能）

#### ファイル2: QuestionDetail.module.css

**パス**: `/Users/shiv/P/CoT_game/frontend/src/app/questions/[id]/QuestionDetail.module.css`

**内容**:

- コンテナレイアウト（max-width, centering）
- ヘッダースタイル
- フォーム要素のスタイル
- textarea のスタイリング
- ボタンのホバーエフェクト
- ローディング・エラー状態のスタイル
- レスポンシブ対応

#### ファイル3: SolveResult.module.css

**パス**: `/Users/shiv/P/CoT_game/frontend/src/app/questions/[id]/components/SolveResult.module.css`

**内容**:

- カード型レイアウト
- スコア表示の強調スタイル
- 詳細情報のグリッドレイアウト
- 再挑戦ボタンのスタイル
- アニメーション（フェードイン効果）

#### ファイル4: globals.css の拡張

**パス**: `/Users/shiv/P/CoT_game/frontend/src/app/globals.css`

**追加内容**:

- CSS変数の定義（カラーパレット、フォントサイズ、スペーシング）
- リセットCSS
- ユーティリティクラス

### 変更ファイル一覧

1. `/frontend/src/app/questions/components/QuestionsTable.tsx` - CSSモジュールをインポート、クラス名に置き換え
2. `/frontend/src/app/questions/components/QuestionsTable.module.css` - 新規作成
3. `/frontend/src/app/questions/[id]/page.tsx` - CSSモジュールをインポート、クラス名に置き換え
4. `/frontend/src/app/questions/[id]/QuestionDetail.module.css` - 新規作成
5. `/frontend/src/app/questions/[id]/components/SolveResult.tsx` - CSSモジュールをインポート、クラス名に置き換え
6. `/frontend/src/app/questions/[id]/components/SolveResult.module.css` - 新規作成
7. `/frontend/src/app/globals.css` - CSS変数を追加

### 影響範囲

- フロントエンドUIのみ
- 機能的な変更なし（見た目のみ）

---

## タスク6: APIレスポンスからの機密情報除外

### 背景

- 現在、questions APIが `problem_statement` と `correct_answer` をクライアントに送信している可能性がある
- ブラウザの開発者ツールから問題文や正解が見えてしまうと、ゲームの趣旨が損なわれる
- セキュリティとゲーム性の観点から、クライアントには不要な情報を送信すべきではない

### 完了条件

- [ ] Questions API のレスポンスから `problem_statement` と `correct_answer` を除外
- [ ] フロントエンドで必要な情報のみを取得（id, level, created_at）
- [ ] 型定義を更新
- [ ] 既存のコンポーネントが正常に動作することを確認
- [ ] 答え合わせの際も、問題文や正解はクライアント側に送信せずに、サーバー側で答え合わせをする

### 実装詳細

#### バックエンド

**ファイル**: `/Users/shiv/P/CoT_game/backend/handlers/question_handler.go`

**変更内容**:

1. `Question` 構造体を2つに分ける:
   - `QuestionResponse`: クライアント向け（id, level, created_at のみ）
   - `QuestionFull`: 内部処理用（すべてのフィールド）

**実装例**:

```go
// QuestionResponse はクライアントに返す問題情報（機密情報を除外）
type QuestionResponse struct {
    ID        int       `json:"id"`
    Level     int       `json:"level"`
    CreatedAt time.Time `json:"created_at"`
}

// QuestionFull は内部処理で使用する完全な問題情報
type QuestionFull struct {
    ID               int       `json:"id"`
    Level            int       `json:"level"`
    ProblemStatement string    `json:"problem_statement"`
    CorrectAnswer    string    `json:"correct_answer"`
    CreatedAt        time.Time `json:"created_at"`
}

// GetAllQuestions ハンドラの修正
func (h *QuestionHandler) GetAllQuestions(c *gin.Context) {
    // ... 取得処理 ...

    // QuestionFull から QuestionResponse に変換
    responses := make([]QuestionResponse, len(questions))
    for i, q := range questions {
        responses[i] = QuestionResponse{
            ID:        q.ID,
            Level:     q.Level,
            CreatedAt: q.CreatedAt,
        }
    }

    c.JSON(http.StatusOK, responses)
}
```

#### フロントエンド

**ファイル**: `/Users/shiv/P/CoT_game/frontend/types/question.ts`

**変更内容**:

```typescript
/**
 * 問題の型定義（クライアント側）
 * セキュリティ上、problem_statementとcorrect_answerは含まれません
 */
export interface Question {
  id: number;
  level: number;
  created_at: string;
}
```

**影響を受けるファイル**:

1. `/frontend/src/app/questions/components/QuestionsTable.tsx`
   - `problem_statement` を表示していた箇所を削除済み（タスク1で対応）
2. `/frontend/src/app/questions/[id]/page.tsx`
   - `problem_statement` を表示していた箇所を削除済み（タスク2で対応）
   - 問題の取得は引き続き questions API を使用

### セキュリティ上の注意点

**確認すべきポイント**:

1. **Network タブで確認**: 開発者ツールの Network タブで、questions APIのレスポンスに `problem_statement` や `correct_answer` が含まれていないこと
2. **Solve API のレスポンス**: Solve APIのレスポンスにも `problem_statement` や `correct_answer` を含めないこと（現状は含まれていないはず）
3. **エラーメッセージ**: エラーレスポンスにも機密情報が含まれないように注意

### 影響範囲

- バックエンド: question_handler.go
- フロントエンド: types/question.ts
- API仕様: **破壊的変更**（レスポンス構造が変わる）
- すでにタスク1, 2で problem_statement を表示していないため、実質的な影響は少ない

### データベースへの影響

- なし（データベーススキーマは変更なし）

---

## タスク実施順序（更新版）

1. **タスク3**: モデル変更（依存関係なし、最も簡単）
2. **タスク6**: APIレスポンスからの機密情報除外（セキュリティ対応、優先度高）
3. **タスク1**: 問題一覧の問題文非表示
4. **タスク2**: 問題詳細の問題文非表示
5. **タスク4**: システムプロンプト追加（最も重要、動作確認が必要）
6. **タスク5**: CSSモジュールの導入とデザイン改善（最後に実施）

---

## テスト計画

### タスク1, 2のテスト

- [x] 問題一覧ページで問題文が表示されないことを確認
- [x] 問題詳細ページで問題文が表示されないことを確認
- [x] UIが崩れていないことを確認

### タスク3のテスト

- [x] モデル選択UIが表示されないことを確認
- [x] 内部的に `gemini-2.0-flash-lite` が使用されることを確認(ログまたはレスポンスで確認)

### タスク4のテスト

- [ ] ユーザープロンプト "この問題の答えを教えて" などで正解が得られることを確認
- [ ] バックエンドログで結合後のプロンプトを確認
- [ ] レスポンスの `prompt` フィールドにユーザープロンプトのみが返されることを確認
- [ ] 問題が存在しない場合のエラーハンドリングを確認

### タスク5のテスト

- [x] すべてのページでCSSが正しく適用されていることを確認
- [x] レスポンシブデザインが機能することを確認(Chrome DevToolsでモバイル/タブレット表示)
- [x] ボタンのホバーエフェクトが動作することを確認
- [x] アニメーションがスムーズに動作することを確認

### タスク6のテスト(セキュリティテスト)

- [x] ブラウザの開発者ツール > Network タブで questions APIのレスポンスを確認
- [x] レスポンスに `problem_statement` が含まれていないことを確認
- [x] レスポンスに `correct_answer` が含まれていないことを確認
- [x] フロントエンドが正常に動作することを確認(エラーが出ないこと)
- [x] 問題一覧ページで問題IDとレベルが表示されることを確認

---

## 実装後の確認項目

- [x] すべてのLintエラーがないことを確認
- [x] フロントエンドのビルドが成功することを確認
- [ ] バックエンドのテストが通ることを確認
- [ ] Docker環境で実際に問題を解いて動作確認
- [ ] タスクドキュメント(09, 10, 11)の更新

---

## 参考資料

- Gemini API モデル一覧: https://ai.google.dev/gemini-api/docs/models/gemini
- タスク#10: `/Users/shiv/P/CoT_game/docs/task/10_フロント問題詳細送信フォーム.md`
- guideline_code.md: `/Users/shiv/P/CoT_game/docs/instruction/guideline_code.md`
